<div id="nice_assets_box">
  <h3>Attachments <%= image_tag('admin/plus.png', :id => "add_nice_asset") %></h3>
  <%= render :partial => 'admin/assets/uploader' %>
  <div class="attachments">
    <ul id="nice_assets">
      <%= render :partial => 'nice_asset', :collection => @page.page_attachments %>
    </ul>
    <div class="clear"></div>
  </div>
</div>

<script type="text/javascript" charset="utf-8">

        // window.AUTH_TOKEN = '#{form_authenticity_token}'; // Fix rails authentication issue
        // 
        // jQuery(document).ajaxSend(function(event, request, settings) {
        //   if (typeof(window.AUTH_TOKEN) == "undefined") return;
        //   // IE6 fix for http://dev.jquery.com/ticket/3155
        //   if (settings.type == 'GET' || settings.type == 'get') return;
        // 
        //   settings.data = settings.data || "";
        //   settings.data += (settings.data ? "&" : "") + "authenticity_token=" + encodeURIComponent(window.AUTH_TOKEN);
        // });

        // Ajax.Base.prototype.initialize = Ajax.Base.prototype.initialize.wrap(
        //    function(p, options){
        //      p(options);
        //      this.options.parameters = this.options.parameters || {};
        //      this.options.parameters.authenticity_token = window._token || '';
        //    }
        // );

  jQuery(document).ready(function() {
    jQuery("#add_nice_asset").mouseup(function() {
      <%- if @page.id -%>
        jQuery("#uploader").modal();
      <%- else -%>
        alert('You must first save this page before you can upload files to it.');
      <%- end -%>
    });
    
    <%- if @page.id -%>
      jQuery("#nice_assets .delete").mouseup(function() {
        var id = jQuery($(this).next()).val();
        jQuery.post("/page_attachments/delete_from_page/" + id, { page_id: <%= @page.id %> },
          function(data){
            jQuery('input[type=hidden][value='+id+']').closest('li').remove();
            // alert(jQuery($(this)).text());
            // jQuery(this).parentNode.parentNode.parentNode.remove();
            // alert('fuck me');
        });
      });
    <%- end -%>
    
  });
</script>

<script type="text/javascript" charset="utf-8">
  function insertAsset(elem, image) {
    // var parts = $('pages').getElementsByClassName('page');
    var pages = $$('#pages .page');
    var parts = $$('#pages .part');
    for (i = 0; i < parts.length; i++) {
     if (pages[i].getStyle('display') != 'none') {
       var filter = parts[i].getElementsByTagName('select')[0];
       var textarea = parts[i].getElementsByTagName('textarea')[0];
       if (image == true) {
         answer = confirm("Insert with link to original file?");
         if (answer) {
           var content = elem.readAttribute('rel_with_link');
         } else {
           var content = elem.readAttribute('rel');
         }
       } else {
         var content = elem.getAttribute('rel');
       }
       if (filter.value == 'TinyMce') {
         tinyMCE.execCommand('mceInsertContent',false,content);
       } else {
         textarea.focus();
         insertAtCursor(textarea, content);
       }
     }
    }
  }
  
  function insertAtCursor(myField, myValue) {
    //IE support
    if (document.selection) {
      myField.focus();
      sel = document.selection.createRange();
      sel.text = myValue;
    }

    //MOZILLA/NETSCAPE support
    else if (myField.selectionStart || myField.selectionStart == '0') {
      var startPos = myField.selectionStart;
      var endPos = myField.selectionEnd;
      myField.value = myField.value.substring(0, startPos)
                    + myValue
                    + myField.value.substring(endPos, myField.value.length);
    } else {
      myField.value += myValue;
    }
  }
  
</script>