<div id="asset-pages-list">
	<div id="page-browse-loading" class="loading-indicator" style="display: none;"></div>
  <%=
  def display_nodes(parent, node = nil)
    if @nodes == nil
      @parent = parent
      icon_name = @parent.virtual? ? "virtual-page" : "page"
      @parent_icon = image(icon_name, :class => "icon", :alt => 'page-icon', :title => '', :align => 'center')
      @ul_level = 0
      @nodes = ''
    end
    if parent.children(true)
      if parent.children.length > 0
        @nodes += %{<ul>\n}
        @ul_level += 1
        @dl = ''
        parent.children.each do |child|
          icon_name = child.virtual? ? "virtual-page" : "page"
          icon = image(icon_name, :class => "icon", :alt => 'page-icon', :title => '', :align => 'center')
          
          if child.children.length > 0
            @nodes += %{<li id="node-#{child.id}">#{link_to_remote '<span class="hidden">+</span>', {:url => {:controller => 'admin/nice_assets', :action => 'browse_pages', :page => @page.id, :node => child.id}, :before => %{this.addClassName('spinner')}}, :class => 'expander' }
            #{icon} 
            #{link_to_remote child.title, :url => {:controller => 'admin/nice_assets', :action => 'link_page', :id => @current_page, :page => child.id}, :before => %{Element.show('page-browse-loading')}}
            }
          else
            @nodes += %{<li id="node-#{child.id}"><span class="expander-placeholder"></span> #{icon} 
            #{link_to_remote child.title, :url => {:controller => 'admin/nice_assets', :action => 'link_page', :id => @current_page, :page => child.id}, :before => %{Element.show('page-browse-loading')}} }
          end
             # .collect{|pa| pa.page_id }.join(', ')  }}
          # if node.id.to_i == child.id
          #   if child.children(true)
          #     display_nodes(child)
          #   end
          # end
        end
        @nodes += "</li>\n"
        if @ul_level > 2
          @nodes += "</ul>\n"
        end
        @ul_level -= 1

        # Don't close unopened <li>
        if @ul_level > 0
          @nodes += "</li>\n"
        end
      end
    end

    return %{<ul id="page-nodes"><li>#{@parent_icon} #{link_to_remote parent.title, :url => {:controller => 'admin/nice_assets', :action => 'link_page', :id => @current_page, :page => parent.id}, :before => %{Element.show('page-browse-loading')}} #{@nodes}</li></ul>}
  end
  
  def match_node(node, match_id)
    unless node.id == match_id
      if parent.children(true)
        parent.children.each do |child|
          match_node(child, match_id)
        end
      end
    end
  end
  %>
  <%= display_nodes(@root, @node) %>
</div>